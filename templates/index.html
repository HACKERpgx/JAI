<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0c0c0d" />
  <link rel="manifest" href="/manifest.json" />
  <title>JAI Assistant</title>
  <style>
    :root { --bg:#020202; --fg:#c8ffdf; --neon:#39ff14; --dim:#0a0a0a; --grid:#0d1f15; --glass:#041a12; --muted:#8bc9a7; }
    html, body { margin:0; padding:0; height:100%; background:#000; color: var(--fg); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    body { display:flex; align-items:flex-start; justify-content:center; min-height:100svh; overflow:auto; padding:16px 0; }
    #rain { position: fixed; inset:0; z-index:0; filter: blur(2px) saturate(120%); opacity:0.35; pointer-events:none; }
    .overlay { position: fixed; inset:0; background: radial-gradient(1200px 800px at 50% 60%, rgba(0,255,140,0.06), transparent 60%); z-index:1; pointer-events:none; }
    .terminal { position: relative; z-index:2; width:min(1100px, 92vw); height:min(70vh, 720px); border:1px solid rgba(57,255,20,0.25); border-radius:14px; background: linear-gradient(180deg, rgba(6,20,14,0.7), rgba(2,10,6,0.85)); box-shadow: 0 0 24px rgba(57,255,20,0.15), inset 0 0 24px rgba(57,255,20,0.05); backdrop-filter: blur(6px); display:flex; flex-direction:column; overflow:hidden; }
    .term-head { display:flex; align-items:center; gap:10px; padding:10px 14px; border-bottom:1px solid rgba(57,255,20,0.2); color: var(--fg); letter-spacing:0.5px; text-shadow: 0 0 6px rgba(57,255,20,0.35); }
    .led { width:10px; height:10px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #b6ffd1, #39ff14 40%, #0c3 60%, #062); box-shadow: 0 0 10px #39ff14, 0 0 20px rgba(57,255,20,0.6); }
    .title { font-weight:700; color:#b6ffd1; }
    .log { flex:1; padding:16px; overflow:auto; display:flex; flex-direction:column; gap:6px; scrollbar-width: thin; }
    .line { color:#b6ffd1; text-shadow: 0 0 8px rgba(57,255,20,0.25); white-space: pre-wrap; }
    .line.me { color:#8fffc9; }
    .line.bot { color:#caffea; }
    .prompt { display:flex; align-items:center; gap:10px; padding:14px; border-top:1px solid rgba(57,255,20,0.2); background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.25)); }
    .caret { color:#39ff14; text-shadow:0 0 8px #39ff14; font-weight:700; }
    #txt { flex:1; background: transparent; color:#d9ffe8; border:none; outline:none; font: 16px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; caret-color:#39ff14; }
    #txt::placeholder { color: rgba(165,255,208,0.35); }
    .blink { width:10px; height:20px; background:#39ff14; box-shadow: 0 0 8px #39ff14, 0 0 16px rgba(57,255,20,0.6); animation: blink 1s step-end infinite; }
    .send { background: rgba(57,255,20,0.1); border:1px solid rgba(57,255,20,0.35); color:#caffea; padding:8px 12px; border-radius:8px; font-weight:700; text-shadow:0 0 6px rgba(57,255,20,0.4); }
    .send:hover { background: rgba(57,255,20,0.16); }
    @keyframes blink { 50% { opacity: 0; } }
    @media (max-width: 640px){ .terminal{ height:min(72vh, 640px);} #txt{ font-size:15px;} }
    .stacker{ display:flex; flex-direction:column; gap:16px; align-items:center; position:relative; z-index:2; margin-left:220px; }
    .attach-row{ display:flex; align-items:center; gap:10px; padding:10px 14px; border-top:1px solid rgba(57,255,20,0.2); background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.25)); }
    .icon-btn{ width:36px; height:36px; border-radius:9999px; border:1px solid rgba(57,255,20,0.35); background: rgba(57,255,20,0.08); color:#b6ffd1; display:grid; place-items:center; transition: background .2s ease, transform .06s ease, color .2s ease, box-shadow .2s ease; }
    .icon-btn:hover{ background: rgba(57,255,20,0.14); color:#d8ffe9; }
    .icon-btn:active{ transform: scale(0.98); }
    .icon-btn:focus-visible{ outline: 3px solid rgba(57,255,20,0.35); outline-offset: 2px; }
    .sidebar{ position:fixed; left:0; top:0; bottom:0; width:220px; background: linear-gradient(180deg, rgba(4,26,18,0.8), rgba(2,10,6,0.92)); border-right:1px solid rgba(57,255,20,0.2); backdrop-filter: blur(6px); z-index:3; display:flex; flex-direction:column; gap:8px; padding:14px 10px; }
    .brand{ font-weight:800; letter-spacing:1px; color:#b6ffd1; text-shadow: 0 0 10px rgba(57,255,20,0.35); padding:8px 10px; border-bottom:1px solid rgba(57,255,20,0.2); margin-bottom:8px; }
    .nav-item{ text-align:left; background: rgba(57,255,20,0.06); border:1px solid rgba(57,255,20,0.25); color:#caffea; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
    .nav-item:hover{ background: rgba(57,255,20,0.12); }
    .nav-item.active{ background: rgba(57,255,20,0.18); box-shadow: 0 0 14px rgba(57,255,20,0.15) inset; }
    .voice-dashboard{ position:relative; z-index:2; margin-left:220px; width:min(1100px, 92vw); }
    .image-dashboard{ position:relative; z-index:2; margin-left:220px; width:min(1100px, 92vw); }
    .voice-panel{ border:1px solid rgba(57,255,20,0.25); border-radius:14px; background: linear-gradient(180deg, rgba(6,20,14,0.7), rgba(2,10,6,0.85)); box-shadow: 0 0 24px rgba(57,255,20,0.15), inset 0 0 24px rgba(57,255,20,0.05); backdrop-filter: blur(6px); padding:14px; }
    .voice-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:4px 6px 10px 6px; border-bottom:1px solid rgba(57,255,20,0.2); margin-bottom:12px; }
    .voice-title{ font-weight:800; color:#b6ffd1; text-shadow: 0 0 6px rgba(57,255,20,0.35); letter-spacing:0.6px; }
    .modes{ display:grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap:12px; }
    .mode-card{ display:flex; flex-direction:column; align-items:center; gap:8px; padding:12px; border:1px solid rgba(57,255,20,0.25); border-radius:12px; background: rgba(57,255,20,0.06); cursor:pointer; transition: transform .1s ease, background .2s ease; }
    .mode-card:hover{ transform: translateY(-1px); background: rgba(57,255,20,0.12); }
    .mode-card.active{ outline: 2px solid rgba(57,255,20,0.5); background: rgba(57,255,20,0.16); }
    .mode-label{ font-weight:700; color:#d8ffe9; font-size:14px; text-align:center; }
    .voice-controls{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:14px; padding-top:12px; border-top:1px solid rgba(57,255,20,0.2); }
    .mic-btn{ width:48px; height:48px; border-radius:9999px; background: rgba(57,255,20,0.12); border:1px solid rgba(57,255,20,0.35); color:#caffea; display:grid; place-items:center; font-weight:800; }
    .mic-btn.recording{ background: rgba(255, 80, 80, 0.18); border-color: rgba(255,80,80,0.5); }
    .wave{ display:flex; align-items:flex-end; gap:3px; height:28px; flex:1; padding:0 6px; }
    .bar{ width:4px; height:6px; background:#39ff14; box-shadow: 0 0 8px rgba(57,255,20,0.4); opacity:0.6; border-radius:2px; transform-origin: bottom center; animation: pulseIdle 1.4s ease-in-out infinite; }
    .wave.listening .bar{ animation: pulseListen 0.8s ease-in-out infinite; }
    .wave.speaking .bar{ animation: pulseSpeak 0.5s ease-in-out infinite; }
    @keyframes pulseIdle { 50% { transform: scaleY(1.2); opacity:0.7; } }
    @keyframes pulseListen { 25% { transform: scaleY(2.2); opacity:1; } 75% { transform: scaleY(0.8); opacity:0.7; } }
    @keyframes pulseSpeak { 20% { transform: scaleY(2.8); opacity:1; } 60% { transform: scaleY(1.2); opacity:0.85; } }
    .voice-log{ margin-top:12px; max-height:220px; overflow:auto; display:flex; flex-direction:column; gap:6px; }
    .vline{ color:#b6ffd1; text-shadow: 0 0 8px rgba(57,255,20,0.25); white-space: pre-wrap; }
    .vline.me{ color:#8fffc9; }
    .vline.bot{ color:#caffea; }
    .img-status{ margin:10px 0; padding:8px 10px; border:1px solid rgba(57,255,20,0.25); border-radius:8px; background: rgba(57,255,20,0.06); color:#caffea; font-weight:700; }
    .img-form{ display:flex; gap:10px; align-items:center; margin:10px 0; }
    .img-input{ flex:1; background: transparent; color:#d9ffe8; border:1px solid rgba(57,255,20,0.35); border-radius:8px; padding:8px 10px; }
    .img-select{ background: transparent; color:#d9ffe8; border:1px solid rgba(57,255,20,0.35); border-radius:8px; padding:8px 10px; }
    .img-btn{ background: rgba(57,255,20,0.1); border:1px solid rgba(57,255,20,0.35); color:#caffea; padding:8px 12px; border-radius:8px; font-weight:700; }
    .img-btn:hover{ background: rgba(57,255,20,0.16); }
    .img-error{ margin:8px 0; color:#ffd1d1; background: rgba(255,80,80,0.12); border:1px solid rgba(255,80,80,0.4); padding:8px 10px; border-radius:8px; display:none; }
    .img-result{ margin-top:12px; display:flex; align-items:center; justify-content:center; }
    .img-result img{ max-width:100%; border-radius:10px; border:1px solid rgba(57,255,20,0.25); box-shadow: 0 0 24px rgba(57,255,20,0.15); }
    .img-loading{ display:none; width:22px; height:22px; border:3px solid rgba(57,255,20,0.25); border-top-color:#39ff14; border-radius:50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tooltip{ position:relative; display:flex; align-items:center; gap:6px; }
    .tip-icon{ width:22px; height:22px; display:grid; place-items:center; border-radius:50%; border:1px solid rgba(57,255,20,0.35); background: rgba(57,255,20,0.08); color:#b6ffd1; font-weight:800; cursor:default; }
    .tip-bubble{ display:none; position:absolute; top:120%; right:0; min-width:280px; max-width:380px; background: rgba(6,20,14,0.95); border:1px solid rgba(57,255,20,0.35); color:#d8ffe9; padding:10px 12px; border-radius:10px; box-shadow: 0 0 14px rgba(57,255,20,0.15); z-index:5; }
    .tooltip:hover .tip-bubble{ display:block; }
    @media (max-width: 940px){ .modes{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 640px){ .stacker{ margin-left:0; } .voice-dashboard{ margin-left:0; } .sidebar{ position:static; width:auto; flex-direction:row; gap:8px; border:0; background:transparent; padding:8px; } .brand{ border:0; margin:0; padding:0 8px; } }
  </style>
</head>
<body>
  <canvas id="rain"></canvas>
  <div class="overlay"></div>
  <nav class="sidebar">
    <div class="brand">JAI</div>
    <button id="navChat" class="nav-item active">Chat</button>
    <button id="navVoice" class="nav-item">Voice Mode</button>
    <button id="navImage" class="nav-item">Image Generator</button>
  </nav>
  <div class="stacker">
    <div class="terminal">
    <div class="term-head">
      <div class="led"></div>
      <div class="title">JAI WEBSITE</div>
    </div>
    <div id="log" class="log"></div>
    <div class="prompt">
      <span class="caret">&gt;</span>
      <input id="txt" type="text" placeholder="Type a command..." autocomplete="off" spellcheck="false" />
      <span class="blink"></span>
      <button id="send" class="send">Send</button>
    </div>
    <div class="attach-row" role="group" aria-label="Attachments">
      <button id="btnPhoto" class="icon-btn" aria-label="Photos" title="Photos">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="3" y="5" width="18" height="14" rx="2"/>
          <circle cx="8.5" cy="9.5" r="1.5"/>
          <path d="M3 16l5-5 4 4 3-3 6 6"/>
        </svg>
      </button>
      <button id="btnVideo" class="icon-btn" aria-label="Videos" title="Videos">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="3" y="5" width="18" height="14" rx="2"/>
          <path d="M7 5v14M17 5v14"/>
          <path d="M12 10l4 2-4 2z" fill="currentColor" stroke="none"/>
        </svg>
      </button>
      <button id="btnRemove" class="icon-btn" aria-label="Remove files" title="Remove files">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M3 6h18"/>
          <path d="M8 6V4h8v2"/>
          <rect x="6" y="6" width="12" height="14" rx="2"/>
          <path d="M10 11v6M14 11v6"/>
        </svg>
      </button>
      <button id="btnFile" class="icon-btn" aria-label="Files" title="Files">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M21.44 11.05l-8.49 8.49a5.5 5.5 0 0 1-7.78-7.78l9.19-9.19a3.5 3.5 0 1 1 4.95 4.95l-9.19 9.19a1.5 1.5 0 0 1-2.12-2.12l8.49-8.49"/>
        </svg>
      </button>
      <button id="btnCamera" class="icon-btn" aria-label="Camera" title="Camera">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="8"/>
          <path d="M12 4.5l3 5-3 3-3-5z" fill="currentColor" stroke="none"/>
          <path d="M20 12l-5 3-3-3 5-3z" fill="currentColor" stroke="none"/>
          <path d="M12 19.5l-3-5 3-3 3 5z" fill="currentColor" stroke="none"/>
        </svg>
      </button>
    </div>
    <input id="filePhoto" type="file" accept="image/*" style="display:none" />
    <input id="fileVideo" type="file" accept="video/*" style="display:none" />
    <input id="fileFile" type="file" style="display:none" />
    <input id="fileCamera" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>
  </div>
  <div id="voiceDash" class="voice-dashboard" style="display:none">
    <div class="voice-panel">
      <div class="voice-head">
        <div class="voice-title">Voice Mode</div>
      </div>
      <div class="modes">
        <div class="mode-card" data-persona="therapist" id="modeTherapist" aria-label="Therapist">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="8" r="4"/>
            <path d="M4 20c1.5-3 4.5-5 8-5s6.5 2 8 5"/>
            <path d="M8 14c0 0 1.5 2 4 2s4-2 4-2"/>
          </svg>
          <div class="mode-label">Therapist</div>
        </div>
        <div class="mode-card" data-persona="storyteller" id="modeStory" aria-label="StoryTeller">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M4 5h12a4 4 0 0 1 4 4v10H8a4 4 0 0 1-4-4V5z"/>
            <path d="M8 9h8M8 13h6"/>
          </svg>
          <div class="mode-label">StoryTeller</div>
        </div>
        <div class="mode-card" data-persona="trivia" id="modeTrivia" aria-label="Trivia Game">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="12" r="9"/>
            <path d="M9 10a3 3 0 1 1 6 0c0 2-3 2.5-3 5"/>
            <circle cx="12" cy="17" r="1"/>
          </svg>
          <div class="mode-label">Trivia Game</div>
        </div>
        <div class="mode-card" data-persona="meditation" id="modeMeditation" aria-label="Meditation">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="12" cy="5" r="2.5"/>
            <path d="M6 21c2-2 4-3 6-3s4 1 6 3M6 14c2-1 4-2 6-2s4 1 6 2"/>
          </svg>
          <div class="mode-label">Meditation</div>
        </div>
        <div class="mode-card" data-persona="motivation" id="modeMotivation" aria-label="Motivation">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M5 12l4 4L19 6"/>
            <path d="M3 12a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"/>
          </svg>
          <div class="mode-label">Motivation</div>
        </div>
      </div>
      <div class="voice-controls">
        <button id="btnMic" class="mic-btn" aria-label="Record"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v6a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10a7 7 0 0 1-14 0"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></button>
        <div id="wave" class="wave">
          <div class="bar" style="animation-delay:0ms"></div>
          <div class="bar" style="animation-delay:60ms"></div>
          <div class="bar" style="animation-delay:120ms"></div>
          <div class="bar" style="animation-delay:180ms"></div>
          <div class="bar" style="animation-delay:240ms"></div>
          <div class="bar" style="animation-delay:300ms"></div>
          <div class="bar" style="animation-delay:360ms"></div>
          <div class="bar" style="animation-delay:420ms"></div>
          <div class="bar" style="animation-delay:480ms"></div>
          <div class="bar" style="animation-delay:540ms"></div>
          <div class="bar" style="animation-delay:600ms"></div>
          <div class="bar" style="animation-delay:660ms"></div>
        </div>
      </div>
      <div id="voiceLog" class="voice-log"></div>
    </div>
  </div>
  <div id="imageDash" class="image-dashboard" style="display:none">
    <div class="voice-panel">
      <div class="voice-head">
        <div class="voice-title">Image Generator</div>
        <div class="tooltip" aria-label="Usage limits">
          <span class="tip-icon">i</span>
          <div class="tip-bubble">Text-to-image generation is limited to 4 per 24 hours for free users.</div>
        </div>
      </div>
      <div id="imgStatus" class="img-status">0 of 4 images used today</div>
      <div class="img-form">
        <input id="imgPrompt" class="img-input" type="text" placeholder="Describe the image you want..." autocomplete="off" spellcheck="false" />
        <select id="imgSize" class="img-select">
          <option value="512x512">512x512</option>
          <option value="768x768">768x768</option>
          <option value="1024x1024" selected>1024x1024</option>
        </select>
        <button id="imgGenerate" class="img-btn">Generate</button>
        <div id="imgLoading" class="img-loading" aria-hidden="true"></div>
      </div>
      <div id="imgError" class="img-error" role="alert"></div>
      <div class="img-result"><img id="imgPreview" alt="Generated image" style="display:none" /></div>
    </div>
  </div>

<script>
  function rid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); }
  const log = document.getElementById('log');
  function push(role, text){
    const div = document.createElement('div');
    div.className = 'line ' + (role === 'me' ? 'me' : 'bot');
    div.textContent = text;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // Image generator logic
  const imgStatus = document.getElementById('imgStatus');
  const imgPrompt = document.getElementById('imgPrompt');
  const imgSize = document.getElementById('imgSize');
  const imgGenerate = document.getElementById('imgGenerate');
  const imgError = document.getElementById('imgError');
  const imgPreview = document.getElementById('imgPreview');
  const imgLoading = document.getElementById('imgLoading');

  function setImgLoading(on){
    try{
      if(on){
        imgLoading.style.display = '';
        imgGenerate.disabled = true;
        imgPrompt.disabled = true;
        imgSize.disabled = true;
      } else {
        imgLoading.style.display = 'none';
        imgGenerate.disabled = false;
        imgPrompt.disabled = false;
        imgSize.disabled = false;
      }
    }catch(_){ }
  }

  function updateImageStatusText(st){
    if(!st) return;
    const used = st.used || 0; const limit = st.limit || 4; const rem = st.remaining ?? Math.max(0, limit - used);
    imgStatus.textContent = `${used} of ${limit} images used today` + (typeof rem === 'number' ? ` • ${rem} remaining` : '');
  }
  async function refreshImageQuota(){
    try{
      const res = await fetch('/api/image/quota');
      const data = await res.json();
      updateImageStatusText(data);
      imgError.style.display = 'none';
      imgError.textContent = '';
    }catch(_){ /* ignore */ }
  }
  async function generateImage(){
    const prompt = (imgPrompt.value || '').trim();
    if(!prompt){ imgError.textContent = 'Please enter a prompt.'; imgError.style.display = ''; return; }
    imgError.style.display = 'none'; imgError.textContent = '';
    try{
      setImgLoading(true);
      imgPreview.style.display = 'none'; imgPreview.removeAttribute('src');
      const res = await fetch('/api/image/generate', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-Request-Id': rid() }, body: JSON.stringify({ prompt, size: imgSize.value }) });
      const data = await res.json();
      if(!res.ok){
        imgError.textContent = (data && data.error) ? data.error : 'Generation failed';
        imgError.style.display = '';
        await refreshImageQuota();
        return;
      }
      updateImageStatusText(data && data.status);
      const url = data && data.imageDataUrl;
      if(url){
        imgPreview.src = url; imgPreview.style.display = '';
      } else {
        imgError.textContent = 'No image returned.'; imgError.style.display = '';
      }
    }catch(_){ imgError.textContent = 'Network error'; imgError.style.display = ''; }
    finally{ setImgLoading(false); }
  }
  imgGenerate.addEventListener('click', generateImage);
  async function sendText(){
    const input = document.getElementById('txt');
    const text = input.value.trim();
    const photoInput = document.getElementById('filePhoto');
    const cameraInput = document.getElementById('fileCamera');
    const imgFile = (photoInput && photoInput.files && photoInput.files[0]) || (cameraInput && cameraInput.files && cameraInput.files[0]) || null;
    if(!text && !imgFile) return;
    if(text) push('me', '> ' + text);
    input.value = '';
    try {
      if(imgFile){
        await sendImage(imgFile, text);
        if(photoInput) photoInput.value = '';
        if(cameraInput) cameraInput.value = '';
      } else {
        const res = await fetch('/api/text', {
          method:'POST',
          headers: { 'Content-Type':'application/json', 'X-Request-Id': rid() },
          body: JSON.stringify({ text })
        });
        const data = await res.json();
        push('bot', (data && data.response) ? data.response : JSON.stringify(data));
      }
    } catch(e){
      push('bot', 'Network error');
    }
  }
  async function sendImage(file, prompt){
    try {
      const form = new FormData();
      form.append('file', file);
      form.append('prompt', prompt || '');
      const res = await fetch('/api/image', { method:'POST', headers: { 'X-Request-Id': rid() }, body: form });
      const data = await res.json();
      push('bot', (data && data.response) ? data.response : JSON.stringify(data));
    } catch(e){
      push('bot', 'Image analysis failed');
    }
  }
  document.getElementById('send').addEventListener('click', sendText);
  document.getElementById('txt').addEventListener('keydown', e=>{ if(e.key==='Enter') sendText(); });
  window.addEventListener('load', ()=>{ document.getElementById('txt').focus(); });

  const btnPhoto = document.getElementById('btnPhoto');
  const btnVideo = document.getElementById('btnVideo');
  const btnRemove = document.getElementById('btnRemove');
  const btnFile = document.getElementById('btnFile');
  const btnCamera = document.getElementById('btnCamera');
  const inPhoto = document.getElementById('filePhoto');
  const inVideo = document.getElementById('fileVideo');
  const inFile = document.getElementById('fileFile');
  const inCamera = document.getElementById('fileCamera');

  function names(list){ try { return Array.from(list || []).map(f=>f.name).join(', ');} catch(_) { return ''; } }
  function showSelect(kind, list){
    const n = names(list);
    if(n){ push('me', '> ' + kind + ': ' + n); }
  }
  if(btnPhoto) btnPhoto.addEventListener('click', ()=> { if(inPhoto) inPhoto.click(); });
  if(btnVideo) btnVideo.addEventListener('click', ()=> { if(inVideo) inVideo.click(); });
  if(btnRemove) btnRemove.addEventListener('click', ()=> {
    if(inPhoto) inPhoto.value = '';
    if(inVideo) inVideo.value = '';
    if(inFile) inFile.value = '';
    if(inCamera) inCamera.value = '';
    push('me', '> Cleared attachments');
  });
  if(btnFile) btnFile.addEventListener('click', ()=> { if(inFile) inFile.click(); });
  if(btnCamera) btnCamera.addEventListener('click', ()=> { if(inCamera) inCamera.click(); });

  if(inPhoto) inPhoto.addEventListener('change', e => showSelect('Photo', e.target.files));
  if(inVideo) inVideo.addEventListener('change', e => showSelect('Video', e.target.files));
  if(inFile) inFile.addEventListener('change', e => showSelect('File', e.target.files));
  if(inCamera) inCamera.addEventListener('change', e => showSelect('Camera', e.target.files));

  const canvas = document.getElementById('rain');
  const ctx = canvas.getContext('2d');
  let fontSize = 16;
  let columns = 0;
  let drops = [];
  const chars = 'アァカサタナハマヤャラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%&*+-<>=?';
  function resize(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    columns = Math.floor(canvas.width / fontSize) + 1;
    drops = Array(columns).fill(0);
  }
  function draw(){
    ctx.fillStyle = 'rgba(0,0,0,0.06)';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#39ff14';
    ctx.font = fontSize + 'px monospace';
    for(let i=0;i<drops.length;i++){
      const text = chars.charAt(Math.floor(Math.random()*chars.length));
      const x = i * fontSize;
      const y = drops[i] * fontSize;
      ctx.fillText(text, x, y);
      if(y > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
    requestAnimationFrame(draw);
  }
  window.addEventListener('resize', resize);
  resize();
  draw();

  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
    });
  }

  const navChat = document.getElementById('navChat');
  const navVoice = document.getElementById('navVoice');
  const navImage = document.getElementById('navImage');
  const stacker = document.querySelector('.stacker');
  const voiceDash = document.getElementById('voiceDash');
  const imageDash = document.getElementById('imageDash');
  function setView(view){
    if(view === 'voice'){
      voiceDash.style.display = '';
      stacker.style.display = 'none';
      imageDash.style.display = 'none';
      navVoice.classList.add('active');
      navChat.classList.remove('active');
      navImage.classList.remove('active');
    } else if(view === 'image'){
      imageDash.style.display = '';
      voiceDash.style.display = 'none';
      stacker.style.display = 'none';
      navImage.classList.add('active');
      navChat.classList.remove('active');
      navVoice.classList.remove('active');
      refreshImageQuota();
    } else {
      voiceDash.style.display = 'none';
      imageDash.style.display = 'none';
      stacker.style.display = '';
      navChat.classList.add('active');
      navVoice.classList.remove('active');
      navImage.classList.remove('active');
    }
  }
  navChat.addEventListener('click', ()=> setView('chat'));
  navVoice.addEventListener('click', ()=> setView('voice'));
  navImage.addEventListener('click', ()=> setView('image'));

  const cards = Array.from(document.querySelectorAll('.mode-card'));
  function highlightCard(id){
    cards.forEach(c=> c.classList.toggle('active', c.id === id));
  }
  async function setPersona(p){
    try{
      const res = await fetch('/api/persona', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ persona:p }) });
      const data = await res.json();
      return !!data && !data.error;
    }catch(_){ return false }
  }
  cards.forEach(c=> c.addEventListener('click', async ()=>{
    const p = c.getAttribute('data-persona');
    const ok = await setPersona(p);
    if(ok) highlightCard(c.id);
  }));

  const voiceLog = document.getElementById('voiceLog');
  function vpush(role, text){
    const d = document.createElement('div');
    d.className = 'vline ' + (role==='me'?'me':'bot');
    d.textContent = text;
    voiceLog.appendChild(d);
    voiceLog.scrollTop = voiceLog.scrollHeight;
  }

  const wave = document.getElementById('wave');
  function setWave(mode){
    wave.classList.remove('listening','speaking');
    if(mode==='listening') wave.classList.add('listening');
    if(mode==='speaking') wave.classList.add('speaking');
  }

  const btnMic = document.getElementById('btnMic');
  let mediaStream = null; let mediaRecorder = null; let chunks = []; let recording = false;
  async function startRec(){
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
      chunks = [];
      mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size>0) chunks.push(e.data) };
      mediaRecorder.onstop = async ()=>{
        try{ mediaStream.getTracks().forEach(t=> t.stop()); }catch(_){ }
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const fd = new FormData();
        fd.append('file', blob, 'voice.webm');
        fd.append('lang', 'en-US');
        setWave('');
        try{
          const res = await fetch('/api/voice', { method:'POST', body: fd, headers: { 'X-Request-Id': rid() } });
          const data = await res.json();
          const t = (data && data.transcript) || '';
          const r = (data && data.response) || '';
          if(t) vpush('me', '> ' + t);
          if(r){ vpush('bot', r); speak(r); }
        }catch(_){ vpush('bot', 'Voice processing failed'); }
      };
      mediaRecorder.start();
      recording = true;
      btnMic.classList.add('recording');
      setWave('listening');
    }catch(_){ vpush('bot', 'Microphone permission denied'); }
  }
  function stopRec(){
    try{ if(mediaRecorder && recording){ mediaRecorder.stop(); } }catch(_){ }
    recording = false;
    btnMic.classList.remove('recording');
  }
  btnMic.addEventListener('click', ()=>{ if(recording){ stopRec(); } else { startRec(); } });

  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.onstart = ()=> setWave('speaking');
      u.onend = ()=> setWave('');
      speechSynthesis.speak(u);
    }catch(_){ /* no-op */ }
  }
</script>
</body>
</html>
